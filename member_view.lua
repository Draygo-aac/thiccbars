STATUSBAR_STYLE = {
  S_HP_PARTY = {
    coords = {
      301,
      20,
      150,
      19
    },
    afterImage_color_up = {
      ConvertColor(86),
      ConvertColor(198),
      ConvertColor(239),
      1
    },
    afterImage_color_down = {
      ConvertColor(86),
      ConvertColor(198),
      ConvertColor(239),
      1
    }
  },
  S_HP_FRIENDLY = {
    coords = {
      301,
      0,
      150,
      19
    },
    afterImage_color_up = {
      ConvertColor(134),
      ConvertColor(207),
      ConvertColor(82),
      1
    },
    afterImage_color_down = {
      ConvertColor(134),
      ConvertColor(207),
      ConvertColor(82),
      1
    }
  },
  S_HP_NEUTRAL = {
    coords = {
      301,
      60,
      150,
      19
    },
    afterImage_color_up = {
      ConvertColor(230),
      ConvertColor(141),
      ConvertColor(36),
      1
    },
    afterImage_color_down = {
      ConvertColor(230),
      ConvertColor(141),
      ConvertColor(36),
      1
    }
  },
  S_HP_HOSTILE = {
    coords = {
      301,
      40,
      150,
      19
    },
    afterImage_color_up = {
      ConvertColor(223),
      ConvertColor(69),
      ConvertColor(69),
      1
    },
    afterImage_color_down = {
      ConvertColor(223),
      ConvertColor(69),
      ConvertColor(69),
      1
    }
  },
  S_HP_PREEMTIVE_STRIKE = {
    coords = {
      301,
      100,
      150,
      19
    },
    afterImage_color_up = {
      ConvertColor(202),
      ConvertColor(110),
      ConvertColor(105),
      1
    },
    afterImage_color_down = {
      ConvertColor(202),
      ConvertColor(110),
      ConvertColor(105),
      1
    }
  },
  S_HP_OFFLINE = {
    coords = {
      301,
      80,
      150,
      19
    },
    afterImage_color_up = {
      ConvertColor(46),
      ConvertColor(46),
      ConvertColor(46),
      1
    },
    afterImage_color_down = {
      ConvertColor(46),
      ConvertColor(46),
      ConvertColor(46),
      1
    }
  },
  S_MP = {
    coords = {
      301,
      140,
      150,
      13
    }
  },
  S_MP_OFFLINE = {
    coords = {
      301,
      154,
      150,
      13
    }
  },
  L_HP_FRIENDLY = {
    coords = {
      0,
      0,
      300,
      19
    },
    afterImage_color_up = {
      ConvertColor(134),
      ConvertColor(207),
      ConvertColor(82),
      1
    },
    afterImage_color_down = {
      ConvertColor(134),
      ConvertColor(207),
      ConvertColor(82),
      1
    }
  },
  L_HP_NEUTRAL = {
    coords = {
      0,
      60,
      300,
      19
    },
    afterImage_color_up = {
      ConvertColor(230),
      ConvertColor(141),
      ConvertColor(36),
      1
    },
    afterImage_color_down = {
      ConvertColor(230),
      ConvertColor(141),
      ConvertColor(36),
      1
    }
  },
  L_HP_HOSTILE = {
    coords = {
      0,
      40,
      300,
      19
    },
    afterImage_color_up = {
      ConvertColor(223),
      ConvertColor(69),
      ConvertColor(69),
      1
    },
    afterImage_color_down = {
      ConvertColor(223),
      ConvertColor(69),
      ConvertColor(69),
      1
    }
  },
  L_HP_PARTY = {
    coords = {
      0,
      20,
      300,
      19
    },
    afterImage_color_up = {
      ConvertColor(86),
      ConvertColor(198),
      ConvertColor(239),
      1
    },
    afterImage_color_down = {
      ConvertColor(202),
      ConvertColor(110),
      ConvertColor(105),
      1
    }
  },
  L_HP_PREEMTIVE_STRIKE = {
    coords = {
      0,
      100,
      300,
      19
    },
    afterImage_color_up = {
      ConvertColor(202),
      ConvertColor(110),
      ConvertColor(105),
      1
    },
    afterImage_color_down = {
      ConvertColor(202),
      ConvertColor(110),
      ConvertColor(105),
      1
    }
  },
  L_HP_OFFLINE = {
    coords = {
      0,
      80,
      300,
      19
    },
    afterImage_color_up = {
      ConvertColor(46),
      ConvertColor(46),
      ConvertColor(46),
      1
    },
    afterImage_color_down = {
      ConvertColor(46),
      ConvertColor(46),
      ConvertColor(46),
      1
    }
  },
  L_MP = {
    coords = {
      0,
      140,
      300,
      13
    }
  },
  L_MP_OFFLINE = {
    coords = {
      0,
      154,
      300,
      13
    }
  },
  HP_RAID = {
    coords = {
      0,
      0,
      62,
      27
    }
  },
  HP_RAID_TANKER = {
    coords = {
      63,
      0,
      62,
      27
    }
  },
  HP_RAID_DEALER = {
    coords = {
      63,
      28,
      62,
      27
    }
  },
  HP_RAID_HEALER = {
    coords = {
      0,
      28,
      62,
      27
    }
  },
  HP_RAID_OFFLINE = {
    coords = {
      0,
      56,
      62,
      27
    }
  },
  MP_RAID = {
    coords = {
      63,
      72,
      62,
      5
    }
  },
  MP_RAID_OFFLINE = {
    coords = {
      63,
      78,
      62,
      5
    }
  },
  S_HP_RAID = {
    coords = {
      63,
      84,
      62,
      16
    }
  },
  S_HP_RAID_TANKER = {
    coords = {
      0,
      84,
      62,
      16
    }
  },
  S_HP_RAID_DEALER = {
    coords = {
      63,
      56,
      62,
      16
    }
  },
  S_HP_RAID_HEALER = {
    coords = {
      0,
      101,
      62,
      16
    }
  },
  S_HP_RAID_OFFLINE = {
    coords = {
      63,
      101,
      62,
      16
    }
  },
  S_MP_RAID = {
    coords = {
      0,
      118,
      62,
      4
    }
  },
  S_MP_RAID_OFFLINE = {
    coords = {
      63,
      118,
      62,
      4
    }
  }
}
WATCH_DEBUFF_ID = { 
18351, -- petify but buff
20349, 
18352, --abyssal petrify
3783, --petrify
3845, --petrify
6967, --jola
21383, --filthy mucus (sealbreaker)
2869, -- enervate
2870,
6955,
15208,
2124,
2745,
1176,
4712,
2835,
101, --enervate
467,  --curse
15210,
20572, --chilling wind
20570, 
20571,
6184, -- leech
14284, --distress
15175,
6896,
6904, --cursed flame
15225, --mark
7188, --TK
2012,
17159,
1169,
4866,
4286,
2261,
551,
771, --charm
21434,
21432
}


globals = require("thiccbars//common")

local BUFF_ANIMATION_TIME = 0.1
local BLINK_START_TIME = 0
local BLINK_HALF_CYCLE = 800

local function SetViewOfBuffWindow(id, w, maxCount)

  --local w = parent:CreateChildWidget("label", "buffwindow", 0 , true)
  w.buffCountOnSingleLine = 12
  w.iconSize = 14
  w.iconXGap = 2
  w.iconYGap = 2
  w.iconSortVertical = false
  w.button = {}
  for i = 1, maxCount do
    local button = CreateItemIconButton(id .. ".button[" .. i .. "]", w)
    
    button:Show(false)
    button:Clickable(false)
    button.anim = false
    F_SLOT.ApplySlotSkin(button, button.back, SLOT_STYLE.BUFF)
    button.leftTimeText = W_CTRL.CreateLabel(id .. ".button[" .. i .. "].leftTimeText", button)
    button.leftTimeText:Clickable(false)
    button.leftTimeText:SetAutoResize(true)
    button.leftTimeText:SetHeight(FONT_SIZE.SMALL)
    button.leftTimeText:AddAnchor("CENTER", button, -2, 0)
    button.leftTimeText.style:SetAlign(ALIGN_CENTER)
    button.leftTimeText.style:SetColor(1, 1, 1, 1)
    button.leftTimeText.style:SetOutline(true)
    local stack = button:CreateChildWidget("label", "stack", 0, true)
    stack:SetAutoResize(true)
    stack:SetHeight(FONT_SIZE.SMALL)
    stack.style:SetAlign(ALIGN_CENTER)
    stack.style:SetShadow(true)
    stack.style:SetFontSize(FONT_SIZE.SMALL)
    --local buff_deco = button:CreateImageDrawable(TEXTURE_PATH.HUD, "overlay")
    --buff_deco:SetExtent(15, 8)

      button.back:SetColor(1, 0, 0, 1)
      --buff_deco:SetColor(1, 0, 0, 1)
      --buff_deco:SetCoords(733, 160, 15, 8)
      --buff_deco:AddAnchor("TOP", button, 0, 0)
      ApplyTextColor(stack, FONT_COLOR.SOFT_RED)
      stack:AddAnchor("BOTTOMLEFT", button, 2, -2)

    w.button[i] = button
  end
  function w:SetVisibleBuffCount(count)
    w.visibleBuffCount = count
  end
  w:SetVisibleBuffCount(maxCount)
  function w:SetLayout(buffCountOnSingleLine, size, xGap, yGap, sortVertical)
    self.iconSortVertical = sortVertical
    if self.buffCountOnSingleLine == buffCountOnSingleLine and self.iconSize == size and self.iconXGap == xGap and self.iconYGap == yGap then
      return
    end
    self.buffCountOnSingleLine = buffCountOnSingleLine
    self.iconSize = size
   -- api.Log:Info(size)
    self.iconXGap = xGap
    self.iconYGap = yGap
    for i = 1, #w.button do
      self.button[i]:SetExtent(size, size)
      self.button[i]:RemoveAllAnchors()
      local row, column
      if sortVertical == true then
        row = math.mod(i - 1, self.buffCountOnSingleLine)
        column = math.floor((i - 1) / self.buffCountOnSingleLine)
      else
        row = math.floor((i - 1) / self.buffCountOnSingleLine)
        column = math.mod(i - 1, self.buffCountOnSingleLine)
      end
      self.button[i]:AddAnchor("TOPLEFT", self, column * (size + xGap), row * (size + yGap))
    end
  end
  --w:SetLayout(w.buffCountOnSingleLine, w.iconSize, w.iconXGap, w.iconYGap, w.iconSortVertical)
  return w
end


local function UpdateExtent(wnd, count)
  local row = math.floor((count - 1) / wnd.buffCountOnSingleLine)
  local column = math.mod(count - 1, wnd.buffCountOnSingleLine)
  if wnd.sortVertical == true then
    row, column = column, row
  end
  if count < wnd.buffCountOnSingleLine then
    wnd:SetExtent((wnd.iconSize + wnd.iconXGap) * (column + 1), (wnd.iconSize + wnd.iconYGap) * (row + 1))
  else
    wnd:SetExtent((wnd.iconSize + wnd.iconXGap) * wnd.buffCountOnSingleLine, (wnd.iconSize + wnd.iconYGap) * (row + 1))
  end
end


function IsInWatchList(buffInfo)
   
    for i = 1, #WATCH_DEBUFF_ID do
        if buffInfo.buff_id == WATCH_DEBUFF_ID[i] then
            return true
        end
    end
    return false
end

function GetWatchedDebuffs(target)
    local watchedDebuffList = {}
    local count = api.Unit:UnitDeBuffCount(target) or 0
    for i = 1, count do
        local buffInfo = api.Unit:UnitDeBuff(target, i)
        if IsInWatchList(buffInfo) then
            table.insert(watchedDebuffList, buffInfo)
        end
    end
    return watchedDebuffList
end

function CreateBuffWindow(id, window, maxCount)
  local w = SetViewOfBuffWindow(id, window, maxCount)
  w.count = -1
  w.buffTypeMap = {}

  function w:ShowLifeTime(show)
    for i = 1, #self.button do
      self.button[i].leftTimeText:Show(false)
    end
  end
  function w:BuffUpdate(target)

    if target == "player" then
        button = self.button[1]
        button:Show(true)
        return
    end
    local count
    local debuffs = GetWatchedDebuffs(target)
    count = #debuffs or 0

    local buffTypeMap = {}
    for i = 1, #self.button do
      local button = self.button[i]
      local buffInfo 

      if i <= count and i <= self.visibleBuffCount then
        buffInfo = debuffs[i]

        if buffInfo ~= nil then
          
          button.index = i
          button.target = target
          if button.t == nil or button.t and button.t.buff_id ~= buffInfo.buff_id then
            F_SLOT.SetIconBackGround(button, buffInfo.path)
          end

          button.t = buffInfo


          local buffType = buffInfo.buff_id
          buffTypeMap[buffType] = i

          button:Show(true)
        end
        
      else
        button.index = nil
        button.target = nil
        button.t = nil
        button:SetAlpha(1)
        button:Show(false)
        button:ReleaseHandler("OnUpdate")
      end
    end
    self.buffTypeMap = buffTypeMap
    if self.count ~= count then
      self.count = count
      UpdateExtent(self, count)
    end
  end
  return w
end




function SetViewOfRaidMember(name, ownId, index, parent)
    local w
    if parent == nil then
        w = api.Interface:CreateEmptyWindow(name, "UIParent")
    else
        w = parent:CreateChildWidget("emptywidget", "eventWindow", 0, true)
    end
    w:SetExtent(globals.MEMBER_WIDTH, globals.MEMBER_HEIGHT)
    
    
    
    w:Show(true)
    local bg = w:CreateNinePartDrawable(TEXTURE_PATH.RAID, "background")
    bg:SetCoords(33, 141, 7, 7)
    bg:SetInset(3, 3, 3, 3)
    bg:SetColor(1, 1, 1, 0.8)
    --bg:Clickable(false)
    local eventWindow = w:CreateChildWidget("emptywidget", "eventWindow", 0, true)
    eventWindow:AddAnchor("TOPLEFT", w, 0, 0)
    eventWindow:AddAnchor("BOTTOMRIGHT", w, 0, 0)
    eventWindow:Show(true)
    local hpBar = W_BAR.CreateStatusBarOfRaidFrame(w:GetId() .. ".hpBar", w)
    hpBar:Show(true)
    hpBar:Clickable(false)
    hpBar.statusBar:Clickable(false)
    hpBar:ApplyBarTexture(STATUSBAR_STYLE.HP_RAID)
    w.hpBar = hpBar
    
    local mpBar = W_BAR.CreateStatusBarOfRaidFrame(w:GetId() .. ".mpBar", w)
    mpBar:Show(true)
    mpBar:Clickable(false)
    mpBar.statusBar:Clickable(false)
    w.mpBar = mpBar
    --api.Log:Info(TEXTURE_PATH.RAID)
    local selectedIcon = w:CreateNinePartDrawable(TEXTURE_PATH.RAID, "overlay")
    selectedIcon:SetInset(7, 7, 7, 7)
    --selectedIcon:SetCoords(87, 123, 15, 15)
    selectedIcon:SetCoords(87, 123, 15, 15)
    selectedIcon:SetVisible(true)
    selectedIcon:SetColor(ConvertColor(50), ConvertColor(219), ConvertColor(39), 1)
    --combatIcon:Clickable(false)
    w.selectedIcon = selectedIcon
    selectedIcon:AddAnchor("TOPLEFT", hpBar, -2, -2)
    selectedIcon:AddAnchor("BOTTOMRIGHT", mpBar, 2, 1)
    
    
    local leaderMark = W_ICON.CreateLeaderMark(w:GetId() .. ".leaderMark", w)
    leaderMark:Show(false)
    w.leaderMark = leaderMark
    leaderMark:Clickable(false)
    
    local nameLabel = w:CreateChildWidget("label", "nameLabel", 0, true)
    nameLabel:Show(true)
    nameLabel:Clickable(false)
    nameLabel:SetLimitWidth(true)
    nameLabel:SetExtent(112, FONT_SIZE.MIDDLE)
    nameLabel.style:SetFontSize(FONT_SIZE.MIDDLE)
    nameLabel.style:SetAlign(ALIGN_LEFT)
    nameLabel:AddAnchor("TOPLEFT", w, 0, 2)
    w.nameLabel = nameLabel
    
    local guildLabel = w:CreateChildWidget("label", "guildLabel", 0, true)
    guildLabel:Show(true)
    guildLabel:Clickable(false)
    guildLabel:SetLimitWidth(true)
    guildLabel:SetExtent(112, FONT_SIZE.SMALL)
    guildLabel.style:SetFontSize(FONT_SIZE.SMALL)
    guildLabel.style:SetAlign(ALIGN_LEFT)
    guildLabel:AddAnchor("BOTTOM", nameLabel, 0, FONT_SIZE.SMALL)
    guildLabel:SetText("")
    w.guildLabel = guildLabel

    
    local marker = w:CreateImageDrawable(TEXTURE_PATH.MAP_ICON, "overlay")
    marker:SetVisible(false)
    marker:SetExtent(18, 18)
    marker:AddAnchor("TOPRIGHT", hpBar, 0, -1)
    w.marker = marker
    --marker:Clickable(false)
    
    local buffWindow = w:CreateChildWidget("label", "buffwindow", 0 , true)
    CreateBuffWindow(w:GetId() .. ".buffWindow", buffWindow, 8)
    --local buffWindow = W_UNIT.CreateBuffWindow(w:GetId() .. ".buffWindow", w, 8, "debuff")
    buffWindow:Show(true)
    buffWindow:Clickable(false)
    w.buffWindow = buffWindow
    
    bg:RemoveAllAnchors()
    bg:AddAnchor("TOPLEFT", hpBar, -3, -3)
    bg:AddAnchor("BOTTOMRIGHT", mpBar, 2, 3)
    bg:Show(true)
    w.bg = bg
    eventWindow:Raise()
  

  function w:SetSimpleMode(settings)
    self.simple = simple
    self:SetExtent(settings.width, settings.hpheight + settings.mpheight)
    self.hpBar:RemoveAllAnchors()
    self.hpBar:AddAnchor("TOPLEFT", self, 0, 0)
    self.hpBar:AddAnchor("TOPRIGHT", self, 0, 0)
    self.hpBar:SetHeight(settings.hpheight)
    self.mpBar:RemoveAllAnchors()
    self.mpBar:AddAnchor("TOPLEFT", self.hpBar, "BOTTOMLEFT", 0, -1)
    self.mpBar:AddAnchor("TOPRIGHT", self.hpBar, "BOTTOMRIGHT", 0, -1)
    self.mpBar:SetHeight(settings.mpheight)
    self.mpBar:ApplyBarTexture(STATUSBAR_STYLE.MP_RAID)

    if settings.mpheight > 0 then
        self.mpBar:Show(true)
    else
        self.mpBar:Show(false)
    end

    self.leaderMark:RemoveAllAnchors()
    self.leaderMark:AddAnchor("TOPLEFT", self, 2, 3)
    self.buffWindow:RemoveAllAnchors()
    --self.buffWindow:AddAnchor("TOP", self.nameLabel, "BOTTOM", 0, 4)
    --self.buffWindow:AddAnchor("LEFT", self, 1, 0)
    self.buffWindow:AddAnchor("BOTTOMLEFT", self.mpBar, 0, -settings.buffsize)
    self.buffWindow:SetLayout(12, settings.buffsize, 0, 2, false)
    self.buffWindow:SetVisibleBuffCount(8)

  end
  function w:TranslucenceFrame(percent)
      self:SetAlpha(percent)
  end

  --w:RemoveAllAnchors()
  --w:AddAnchor("CENTER", "UIParent", offsetX, offsetY)
  return w
end

return SetViewOfRaidMember